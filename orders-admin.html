<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="lv12.ico" type="image/x-icon">
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="container mx-auto py-10">
    <h1 class="text-3xl font-bold mb-6 text-center">๐ ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</h1>

    <!-- ููุชุฑ ุงูุชุงุฑูุฎ -->
    <div class="bg-white p-4 rounded shadow mb-6 flex flex-col md:flex-row gap-4 items-center justify-center">
      <label>ูู: <input type="date" id="start-date" class="border rounded p-1"></label>
      <label>ุฅูู: <input type="date" id="end-date" class="border rounded p-1"></label>
      <button onclick="applyFilter()" class="bg-blue-600 text-white px-4 py-2 rounded">๐ ููุชุฑุฉ</button>
      <button onclick="resetFilter()" class="bg-gray-500 text-white px-4 py-2 rounded">โป๏ธ ุฅุนุงุฏุฉ ุชุนููู</button>
    </div>

    <!-- ุฌุฏูู ุงูุทูุจุงุช ููุฏ ุงูุชูุตูู -->
    <h2 class="text-2xl font-bold mb-3 text-blue-700">๐ ุงูุทูุจุงุช ููุฏ ุงูุชูุตูู</h2>
    <table class="w-full bg-white rounded shadow-md mb-10">
      <thead>
        <tr class="bg-gray-200">
          <th class="p-2">ุฑูู ุงูุทูุจ</th>
          <th class="p-2">ุงูุนููู</th>
          <th class="p-2">ุงููุงุชู</th>
          <th class="p-2">ุงูุนููุงู</th>
          <th class="p-2">ุงูููุชุฌ</th>
          <th class="p-2">ุงููููุฉ</th>
          <th class="p-2">ุงูุญุงูุฉ</th>
          <th class="p-2">ุฅุฌุฑุงุกุงุช</th>
        </tr>
      </thead>
      <tbody id="shipped-orders"></tbody>
    </table>

    <!-- ุฌุฏูู ุงูุทูุจุงุช ุชู ุงูุชุณููู -->
    <h2 class="text-2xl font-bold mb-3 text-green-700">โ ุงูุทูุจุงุช ุงูุชู ุชู ุชุณููููุง</h2>
    <table class="w-full bg-white rounded shadow-md">
      <thead>
        <tr class="bg-gray-200">
          <th class="p-2">ุฑูู ุงูุทูุจ</th>
          <th class="p-2">ุงูุนููู</th>
          <th class="p-2">ุงููุงุชู</th>
          <th class="p-2">ุงูุนููุงู</th>
          <th class="p-2">ุงูููุชุฌ</th>
          <th class="p-2">ุงููููุฉ</th>
          <th class="p-2">ุงูุญุงูุฉ</th>
        </tr>
      </thead>
      <tbody id="delivered-orders"></tbody>
    </table>
  </div>

<script>
  const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const ADMIN_EMAIL = "lv12wlv12@gmail.com"; 

  // โ ุชุฃููู ุงูุฏุฎูู
  async function checkAuth() {
    const { data } = await supabase.auth.getSession();
    if (!data.session || data.session.user.email !== ADMIN_EMAIL) {
      alert("๐ซ ุบูุฑ ูุณููุญ ูู ุจุงูุฏุฎูู");
      window.location.href = "index.html";
      return false;
    }
    return true;
  }

  let filterStart = null;
  let filterEnd = null;

  // โ ุชุญููู ุงูุทูุจุงุช
  async function loadOrders() {
    let query = supabase
      .from("orders")
      .select("id, name, phone, address, quantity, status, created_at, product_id, products(id, name, stock, sold)")
      .order("id", { ascending: false });

    if (filterStart) query = query.gte("created_at", filterStart + "T00:00:00");
    if (filterEnd) query = query.lte("created_at", filterEnd + "T23:59:59");

    const { data: orders, error } = await query;
    if (error) {
      console.error(error);
      alert("โ ุฎุทุฃ ูู ุชุญููู ุงูุทูุจุงุช");
      return;
    }

    const shippedTable = document.getElementById("shipped-orders");
    const deliveredTable = document.getElementById("delivered-orders");
    shippedTable.innerHTML = "";
    deliveredTable.innerHTML = "";

    orders.forEach(order => {
      let row = `
        <tr class="border-b">
          <td class="p-2">${order.id}</td>
          <td class="p-2">${order.name}</td>
          <td class="p-2">${order.phone}</td>
          <td class="p-2">${order.address}</td>
          <td class="p-2">${order.products?.name || "โ ููุชุฌ ูุญุฐูู"}</td>
          <td class="p-2">${order.quantity}</td>
          <td class="p-2">
            <span class="px-2 py-1 rounded ${
              order.status === "delivered" ? "bg-green-200 text-green-800" : 
              order.status === "shipped" ? "bg-blue-200 text-blue-800" : 
              order.status === "cancelled" ? "bg-red-200 text-red-800" :
              "bg-yellow-200 text-yellow-800"
            }">${order.status}</span>
          </td>
      `;

      if (order.status === "shipped") {
        row += `
          <td class="p-2 flex gap-1">
            <button onclick="updateStatus(${order.id}, '${order.product_id}', ${order.quantity}, 'delivered')" class="bg-green-500 text-white px-2 py-1 rounded">โ ุชู ุงูุชุณููู</button>
            <button onclick="updateStatus(${order.id}, '${order.product_id}', ${order.quantity}, 'cancelled')" class="bg-red-500 text-white px-2 py-1 rounded">โ ุฅูุบุงุก</button>
          </td>
        </tr>`;
        shippedTable.innerHTML += row;
      } else if (order.status === "delivered") {
        row += "</tr>";
        deliveredTable.innerHTML += row;
      }
    });
  }

  // โ ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ
  async function updateStatus(orderId, productId, qty, newStatus) {
    const { error } = await supabase
      .from("orders")
      .update({ status: newStatus })
      .eq("id", orderId);

    if (error) {
      alert("โ ุญุตู ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุทูุจ");
      console.error(error);
      return;
    }

    if (newStatus === "delivered") {
      const { data: product } = await supabase
        .from("products")
        .select("stock, sold")
        .eq("id", productId)
        .single();

      if (product) {
        const newStock = Math.max(0, product.stock - qty); // โ ุญูุงูุฉ ูู ุงูููู ุงูุณุงูุจุฉ
        await supabase
          .from("products")
          .update({
            stock: newStock,
            sold: (product.sold || 0) + qty
          })
          .eq("id", productId);
      }
    }

    alert("โ ุชู ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ");
    loadOrders();
  }

  function applyFilter() {
    filterStart = document.getElementById("start-date").value;
    filterEnd = document.getElementById("end-date").value;
    loadOrders();
  }

  function resetFilter() {
    document.getElementById("start-date").value = "";
    document.getElementById("end-date").value = "";
    filterStart = null;
    filterEnd = null;
    loadOrders();
  }

  // โ ุชุดุบูู ุจุนุฏ ุงูุชุฃูุฏ ูู ุงูุฃุฐู
  (async () => {
    if (await checkAuth()) {
      loadOrders();
    }
  })();
</script>

</body>
</html>

