<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إدارة الطلبات</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="lv12.ico" type="image/x-icon">
</head>
<body class="bg-gray-100 min-h-screen">
<div class="container mx-auto py-10">
  <h1 class="text-3xl font-bold mb-6 text-center">📋 إدارة الطلبات</h1>

  <div class="bg-white p-4 rounded shadow mb-6 flex flex-col md:flex-row gap-4 items-center justify-center">
    <label>من: <input type="date" id="start-date" class="border rounded p-1"></label>
    <label>إلى: <input type="date" id="end-date" class="border rounded p-1"></label>
    <button onclick="applyFilter()" class="bg-blue-600 text-white px-4 py-2 rounded">🔍 فلترة</button>
    <button onclick="resetFilter()" class="bg-gray-500 text-white px-4 py-2 rounded">♻️ إعادة تعيين</button>
  </div>

  <h2 class="text-2xl font-bold mb-3 text-yellow-700">🕒 الطلبات المعلقة</h2>
  <table class="w-full bg-white rounded shadow-md mb-10">
    <thead>
      <tr class="bg-gray-200">
        <th class="p-2">رقم الطلب</th>
        <th class="p-2">العميل</th>
        <th class="p-2">الهاتف</th>
        <th class="p-2">العنوان</th>
        <th class="p-2">المنتج</th>
        <th class="p-2">الكمية</th>
        <th class="p-2">الحالة</th>
        <th class="p-2">إجراءات</th>
        <th class="p-2">ميعاد التوصيل</th>

      </tr>
    </thead>
    <tbody id="pending-orders"></tbody>
  </table>

  <h2 class="text-2xl font-bold mb-3 text-blue-700">🚚 الطلبات قيد التوصيل</h2>
  <table class="w-full bg-white rounded shadow-md mb-10">
    <thead>
      <tr class="bg-gray-200">
        <th class="p-2">رقم الطلب</th>
        <th class="p-2">العميل</th>
        <th class="p-2">الهاتف</th>
        <th class="p-2">العنوان</th>
        <th class="p-2">المنتج</th>
        <th class="p-2">الكمية</th>
        <th class="p-2">الحالة</th>
        <th class="p-2">إجراءات</th>
      </tr>
    </thead>
    <tbody id="shipped-orders"></tbody>
  </table>

  <h2 class="text-2xl font-bold mb-3 text-green-700">✅ الطلبات التي تم تسليمها</h2>
  <table class="w-full bg-white rounded shadow-md mb-10">
    <thead>
      <tr class="bg-gray-200">
        <th class="p-2">رقم الطلب</th>
        <th class="p-2">العميل</th>
        <th class="p-2">الهاتف</th>
        <th class="p-2">العنوان</th>
        <th class="p-2">المنتج</th>
        <th class="p-2">الكمية</th>
        <th class="p-2">الحالة</th>
      </tr>
    </thead>
    <tbody id="delivered-orders"></tbody>
  </table>

  <h2 class="text-2xl font-bold mb-3 text-red-700">❌ الطلبات الملغاة</h2>
  <table class="w-full bg-white rounded shadow-md">
    <thead>
      <tr class="bg-gray-200">
        <th class="p-2">رقم الطلب</th>
        <th class="p-2">العميل</th>
        <th class="p-2">الهاتف</th>
        <th class="p-2">العنوان</th>
        <th class="p-2">المنتج</th>
        <th class="p-2">الكمية</th>
        <th class="p-2">الحالة</th>
      </tr>
      <button onclick="setDeliveryDate(${order.id})" 
  class="bg-purple-500 text-white px-2 py-1 rounded">📅 تحديد الميعاد</button>

    </thead>
    <tbody id="cancelled-orders"></tbody>
  </table>
</div>

<script>
  const SUPABASE_URL = "https://nszhzfysitppxssplqfb.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5zemh6ZnlzaXRwcHhzc3BscWZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMzA4OTcsImV4cCI6MjA3MzgwNjg5N30.5KvK4bhqkZ_GpIfED4qecIMfeubAJYwSFJslULwOp-w";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const ADMIN_EMAIL = "lv12wlv12@gmail.com"; 

  async function checkAuth() {
    const { data } = await supabase.auth.getSession();
    if (!data.session || data.session.user.email !== ADMIN_EMAIL) {
      alert("🚫 غير مسموح لك بالدخول");
      window.location.href = "index.html";
      return false;
    }
    return true;
  }

  let filterStart = null;
  let filterEnd = null;

 


  async function setDeliveryDate(orderId) {
  const input = document.getElementById(`delivery-${orderId}`);
  if (!input || !input.value) {
    alert("⚠️ اختر ميعاد التوصيل أولاً");
    return;
  }

  const deliveryDate = new Date(input.value);

  const { error } = await supabase
    .from("orders")
    .update({ delivery_date: deliveryDate.toISOString() })
    .eq("id", orderId);

  if (error) {
    alert("❌ فشل تحديد ميعاد التوصيل: " + error.message);
    return;
  }

  alert("✅ تم تحديد ميعاد التوصيل بنجاح");
  loadOrders();
}

async function loadOrders() {
  let query = supabase
    .from("orders")
    .select("id, name, phone, address, quantity, status, created_at, product_id")
    .order("id", { ascending: false });

  if (filterStart) query = query.gte("created_at", filterStart + "T00:00:00");
  if (filterEnd) query = query.lte("created_at", filterEnd + "T23:59:59");

  const { data: orders, error } = await query;
  if (error) {
    console.error(error);
    alert("❌ خطأ في تحميل الطلبات: " + error.message);
    return;
  }

  const pendingTable = document.getElementById("pending-orders");
  const shippedTable = document.getElementById("shipped-orders");
  const deliveredTable = document.getElementById("delivered-orders");
  const cancelledTable = document.getElementById("cancelled-orders");

  pendingTable.innerHTML = "";
  shippedTable.innerHTML = "";
  deliveredTable.innerHTML = "";
  cancelledTable.innerHTML = "";

  for (const order of orders) {
    let productName = "❌ منتج محذوف";
    try {
      const { data: product } = await supabase
        .from("products")
        .select("name")
        .eq("id", order.product_id)
        .single();

      if (product) productName = product.name;
    } catch (e) {
      console.warn("Product not found for order", order.id);
    }

    let row = `
      <tr class="border-b">
        <td class="p-2">${order.id}</td>
        <td class="p-2">${order.name}</td>
        <td class="p-2">${order.phone}</td>
        <td class="p-2">${order.address}</td>
        <td class="p-2">${productName}</td>
        <td class="p-2">${order.quantity}</td>
        <td class="p-2">
          <span class="px-2 py-1 rounded ${
            order.status === "delivered" ? "bg-green-200 text-green-800" : 
            order.status === "shipped" ? "bg-blue-200 text-blue-800" : 
            order.status === "cancelled" ? "bg-red-200 text-red-800" :
            "bg-yellow-200 text-yellow-800"
          }">${order.status}</span>
        </td>
        <td class="p-2">
  ${order.delivery_date 
    ? new Date(order.delivery_date).toLocaleString("ar-EG") 
    : `<input type="datetime-local" id="delivery-${order.id}" class="border p-1 rounded">`}
</td>

    `;

    if (order.status === "pending") {
      row += `
        <td class="p-2 flex gap-1">
          <button onclick="updateStatus(${order.id}, '${order.product_id}', ${order.quantity}, 'shipped')" class="bg-blue-500 text-white px-2 py-1 rounded">🚚 شحن</button>
          <button onclick="updateStatus(${order.id}, '${order.product_id}', ${order.quantity}, 'cancelled')" class="bg-red-500 text-white px-2 py-1 rounded">❌ إلغاء</button>
        </td>
      </tr>`;
      pendingTable.innerHTML += row;
    } else if (order.status === "shipped") {
      row += `
        <td class="p-2 flex gap-1">
          <button onclick="updateStatus(${order.id}, '${order.product_id}', ${order.quantity}, 'delivered')" class="bg-green-500 text-white px-2 py-1 rounded">✅ تم التسليم</button>
          <button onclick="updateStatus(${order.id}, '${order.product_id}', ${order.quantity}, 'cancelled')" class="bg-red-500 text-white px-2 py-1 rounded">❌ إلغاء</button>
        </td>
      </tr>`;
      shippedTable.innerHTML += row;
    } else if (order.status === "delivered") {
      row += "</tr>";
      deliveredTable.innerHTML += row;
    } else if (order.status === "cancelled") {
      row += "</tr>";
      cancelledTable.innerHTML += row;
    }
  }
}

  async function updateStatus(orderId, productId, qty, newStatus) {
    const { error } = await supabase
      .from("orders")
      .update({ status: newStatus })
      .eq("id", orderId);

    if (error) {
      alert("❌ خطأ في تحديث الطلب: " + error.message);
      console.error(error);
      return;
    }

    if (newStatus === "delivered") {
      const { data: product } = await supabase
        .from("products")
        .select("stock, sold")
        .eq("id", productId)
        .single();

      if (product) {
        const newStock = Math.max(0, product.stock - qty);
        await supabase
          .from("products")
          .update({
            stock: newStock,
            sold: (product.sold || 0) + qty
          })
          .eq("id", productId);
      }
    }

    alert("✅ تم تحديث حالة الطلب");
    loadOrders();
  }

  function applyFilter() {
    filterStart = document.getElementById("start-date").value;
    filterEnd = document.getElementById("end-date").value;
    loadOrders();
  }

  function resetFilter() {
    document.getElementById("start-date").value = "";
    document.getElementById("end-date").value = "";
    filterStart = null;
    filterEnd = null;
    loadOrders();
  }

  (async () => {
    if (await checkAuth()) {
      loadOrders();
    }
  })();
</script>

</body>
</html>

